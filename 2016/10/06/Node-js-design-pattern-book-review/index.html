
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Blog | qetr1ck-op">
    <title>Node.js design pattern book review - Blog | qetr1ck-op</title>
    <meta name="author" content="Orest Prystayko">
    
    
        <link rel="icon" href="http://qetr1ck-op.github.io/assets/images/favicon.ico">
    
    
    <meta name="description" content="“How could I organize my code?”, “What is the best way to design this?”, “How can I make my application more modular?”, “How do I handle a set of asynchronous call effectively?”, “How can I make sure">
<meta property="og:type" content="blog">
<meta property="og:title" content="Node.js design pattern book review">
<meta property="og:url" content="http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/index.html">
<meta property="og:site_name" content="Blog | qetr1ck-op">
<meta property="og:description" content="“How could I organize my code?”, “What is the best way to design this?”, “How can I make my application more modular?”, “How do I handle a set of asynchronous call effectively?”, “How can I make sure">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/blocking-input-output.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/webserver-event-demultiplexer.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/reactor-pattern.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/building-nodejs-blocks.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/async-cps-in-action.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/event-emitter.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/sequential-execution.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/parallel-execution.png">
<meta property="og:image" content="http://qetr1ck-op.github.io/images/parallel-execution-diagram.png">
<meta property="og:updated_time" content="2016-10-19T20:32:20.386Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node.js design pattern book review">
<meta name="twitter:description" content="“How could I organize my code?”, “What is the best way to design this?”, “How can I make my application more modular?”, “How do I handle a set of asynchronous call effectively?”, “How can I make sure">
<meta name="twitter:image" content="http://qetr1ck-op.github.io/images/blocking-input-output.png">
<meta name="twitter:creator" content="@https://twitter.com/oprystayko">
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/35948c039f71fe48d765768c07bfee67?s=640"/>
    
    
        <meta property="og:image" content="https://www.packtpub.com/sites/default/files/5587OS_5259_Node.js%20Design%20Platforms.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://www.packtpub.com/sites/default/files/5587OS_5259_Node.js%20Design%20Platforms.jpg" />
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-7wogkojxptddmu9j7rnfepcopyzxvqlggl6wahgu3asfris9wednofoeicxu.min.css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Blog | qetr1ck-op</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="#search">
        
        
            <i class="fa fa-lg fa-search"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="4">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/35948c039f71fe48d765768c07bfee67?s=110"/>
            </a>
            <span class="sidebar-profile-name">Orest Prystayko</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/qetr1ck-op" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.linkedin.com/profile/preview?locale=ru_RU&trk=prof-0-sb-preview-primary-button" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">LinkedIn</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/oprystayko" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.facebook.com/orest.prustayko" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                    <span class="sidebar-button-desc">Facebook</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Node.js design pattern book review
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" datetime="2016-10-06T21:11:33+03:00">
	
		    Oct 06, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Javascript/">Javascript</a>, <a class="category-link" href="/categories/Javascript/Node-js/">Node.js</a>


    
</div>

</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>“How could I organize my code?”, “What is the best way to design this?”, “How can I make my application more modular?”, “How do I handle a set of asynchronous call effectively?”, “How can I make sure that my application will not collapse while it grows?”.</p>
<p>If you have such questions without answers, that book is definitely for you!</p>
<p>The aim of this book is to guide you through this emerging world of patterns, techniques and practices, showing proven solution to the common problem.</p>
<a id="more"></a>
<h1 id="table-of-contents">Table of Contents</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter_1_3A_Welcome_to_the_Node-js_platform"><span class="toc-text">Chapter 1: Welcome to the Node.js platform</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The_Node-js_philosophy"><span class="toc-text">The Node.js philosophy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I/O_is_slow"><span class="toc-text">I/O is slow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blocking_I/O"><span class="toc-text">Blocking I/O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Non-blocking_I/O_with__u201Cbusy-waiting_u201D"><span class="toc-text">Non-blocking I/O with “busy-waiting”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Event_demultiplexing"><span class="toc-text">Event demultiplexing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The_reactor_pattern"><span class="toc-text">The reactor pattern</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The_non-blocking_I/O_engine_of_Node-js-libuv"><span class="toc-text">The non-blocking I/O engine of Node.js-libuv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The_building_blocks_of_Node-js_platform"><span class="toc-text">The building blocks of Node.js platform</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter_2_3A_Node-js_essential_patterns"><span class="toc-text">Chapter 2: Node.js essential patterns</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The_callback_pattern"><span class="toc-text">The callback pattern</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The_continue-passing_style"><span class="toc-text">The continue-passing style</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Asynchronous_continue-passing_style"><span class="toc-text">Asynchronous continue-passing style</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Synchronous_or_asynchronous_3F"><span class="toc-text">Synchronous or asynchronous?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#An_unpredictable_function"><span class="toc-text">An unpredictable function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unleashing_Zalgo"><span class="toc-text">Unleashing Zalgo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using_synchronous_APIs"><span class="toc-text">Using synchronous APIs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using_asynchronous_operation_with_deferred_execution"><span class="toc-text">Using asynchronous operation with deferred execution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-js_callback_convention"><span class="toc-text">Node.js callback convention</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Callback_come_last"><span class="toc-text">Callback come last</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Error_comes_first"><span class="toc-text">Error comes first</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Propagation_errors"><span class="toc-text">Propagation errors</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The_module_system_and_its_pattern"><span class="toc-text">The module system and its pattern</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The_revealing_module_pattern"><span class="toc-text">The revealing module pattern</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-js_modules_explained"><span class="toc-text">Node.js modules explained</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#A_homemade_module_loader"><span class="toc-text">A homemade module loader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Defining_a_modules"><span class="toc-text">Defining a modules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Defining_globals"><span class="toc-text">Defining globals</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u201Cmodule-exports_u201D_VS__u201Cexports_u201D"><span class="toc-text">“module.exports” VS “exports”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#The__u201Crequire_u201D_function_is_synchronous"><span class="toc-text">The “require” function is synchronous</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#The_resolving_algorithm"><span class="toc-text">The resolving algorithm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#The_module_cache"><span class="toc-text">The module cache</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module_definition_patterns"><span class="toc-text">Module definition patterns</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Named_exports"><span class="toc-text">Named exports</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exporting_a_function"><span class="toc-text">Exporting a function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exporting_a_constructor"><span class="toc-text">Exporting a constructor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exporting_an_instance"><span class="toc-text">Exporting an instance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Modifying_other_modules_or_the_global_scope"><span class="toc-text">Modifying other modules or the global scope</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The_observer_pattern"><span class="toc-text">The observer pattern</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The_EventEmitter_class"><span class="toc-text">The EventEmitter class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating_and_using_EventEmitter"><span class="toc-text">Creating and using EventEmitter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extends_from_EventEmitter_class"><span class="toc-text">Extends from EventEmitter class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Combining_callbacks_with_EventEmitter"><span class="toc-text">Combining callbacks with EventEmitter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter_3_3A_Asynchronous_control_flow_patterns_with_callbacks"><span class="toc-text">Chapter 3: Asynchronous control flow patterns with callbacks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating_a_simple_web_spider"><span class="toc-text">Creating a simple web spider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The_callback_hell"><span class="toc-text">The callback hell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Applying_the_callback_discipline"><span class="toc-text">Applying the callback discipline</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sequential_execution"><span class="toc-text">Sequential execution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution_a_set_of_known_task_in_sequence"><span class="toc-text">Execution a set of known task in sequence</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sequential_iteration_with_crawling_of_links"><span class="toc-text">Sequential iteration with crawling of links</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The_pattern__u201Csequential_iteration_u201D"><span class="toc-text">The pattern “sequential iteration”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Parallel_execution"><span class="toc-text">Parallel execution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution_with__u201CspiderLinks_u201D"><span class="toc-text">Execution with “spiderLinks”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The_pattern__u201Cunlimited_parallel_execution_u201D"><span class="toc-text">The pattern “unlimited parallel execution”</span></a></li></ol></li></ol></li></ol>
<h1 id="Chapter_1_3A_Welcome_to_the_Node-js_platform"><a href="#Chapter_1_3A_Welcome_to_the_Node-js_platform" class="headerlink" title="Chapter 1: Welcome to the Node.js platform"></a>Chapter 1: Welcome to the Node.js platform</h1><h2 id="The_Node-js_philosophy"><a href="#The_Node-js_philosophy" class="headerlink" title="The Node.js philosophy"></a>The Node.js philosophy</h2><p>Some of these principles arise from the technology itself, some of them are enabled by its ecosystem, some are just trends in community, some directly comes from its creator, another are influenced by the Unix culture.</p>
<ul>
<li>Small core</li>
<li>Small modules</li>
<li>Small surface area</li>
<li>Simplicity and pragmatism</li>
</ul>
<h2 id="I/O_is_slow"><a href="#I/O_is_slow" class="headerlink" title="I/O is slow"></a>I/O is slow</h2><p>I/O is definitely the slowest among the fundamental operations of a computer. Accessing to RAM is in the order of nanoseconds, while accessing data on disk the network is in order of milliseconds. For the bandwidth is the same story. RAM has a transfer rate consistently in the order of GB/s, while disk and network varies from MB/s to, optimistically, GB/s.</p>
<p>On the top of that, we also have to consider the human factor. Often input of an application comes from a real person, so the speed or frequency of I/O doesn’t only depend on technical aspects.</p>
<h3 id="Blocking_I/O"><a href="#Blocking_I/O" class="headerlink" title="Blocking I/O"></a>Blocking I/O</h3><p>In traditional blocking I/O programming the function call corresponding to an I/O request will block the execution of the thread until the operation completes.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// block the thread until the data is available</span></span><br><span class="line">data = socket.read()</span><br><span class="line"><span class="comment">// data is available</span></span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>
<p>It’s trivial to notice how web-server which is using blocking I/O will not be able to handle multiple connection in the same thread. Each operation will block the processing of any other connection:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/blocking-input-output.png" title="" data-fancybox-group=""><img class="fig-img" src="images/blocking-input-output.png" alt=""></a></div>
<p>The preceding image emphasis on the amount of time each thread is idle, waiting for new data to be received from associated connection. Also we need to consider how much time of I/O can possibly block a request, for example, while interacting with database or with filesystem.</p>
<h3 id="Non-blocking_I/O_with__u201Cbusy-waiting_u201D"><a href="#Non-blocking_I/O_with__u201Cbusy-waiting_u201D" class="headerlink" title="Non-blocking I/O with “busy-waiting”"></a>Non-blocking I/O with “busy-waiting”</h3><p>In this operation mode, the system call always returns immediately without waiting for data to be read or written. If no result are available at the moment of call, the function will simply return a predefined constant, indicating that there is no data available to return at the moment.</p>
<p>The most basic pattern for accessing this kind of non-blocking I/O is <code>busy-waiting</code> - it actively poll the resource within a loop until some actual data is returned.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">resource = [socketA, socketB, pipeA]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!resources.isEmpty()) &#123;</span><br><span class="line">  foreach resource <span class="keyword">in</span> resources &#123;</span><br><span class="line">    <span class="comment">// try to read</span></span><br><span class="line">    <span class="keyword">let</span> data = resource.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data === NO_DATA_AVAILABLE) &#123;</span><br><span class="line">      <span class="comment">// there is no data to read at the moment</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (data === RESOUCE_CLOSED) &#123;</span><br><span class="line">      <span class="comment">// there was closed, remove it from list</span></span><br><span class="line">      resources.remove(resource)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// data was received, proceed it</span></span><br><span class="line">      consumeData(data)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this technique it’s already possible to achieve handling different resources in the same thread, but still it isn’t efficient.</p>
<h3 id="Event_demultiplexing"><a href="#Event_demultiplexing" class="headerlink" title="Event demultiplexing"></a>Event demultiplexing</h3><p>Luckily, most modern operation systems provide a mechanism to handle concurrent, non-blocking resources in efficient way. It’s a <code>synchronous event demultiplexing</code> or <code>event notification interface</code> - it’s collect and queues I/O events that come from set of watched resources, and block until new events are available for process.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">watchedList.add(socketA, FOR_READ)</span><br><span class="line">watchedList.add(socketB, FOR_READ)</span><br><span class="line">watchedList.add(pipeA, FOR_READ) <span class="comment">// [1]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(events = demultiplexer.watch(watchedList)) &#123; <span class="comment">// [2]</span></span><br><span class="line">  <span class="comment">// event loop</span></span><br><span class="line">  foreach (event <span class="keyword">in</span> events) &#123; <span class="comment">// [3]</span></span><br><span class="line">    <span class="comment">// this read operation won't never block</span></span><br><span class="line">    <span class="comment">// and we will always return data</span></span><br><span class="line">    data = event.resource.read()</span><br><span class="line">    <span class="keyword">if</span> (data === RESOUCE_CLOSED) &#123;</span><br><span class="line">      <span class="comment">// remove from watched list</span></span><br><span class="line">      demultiplexer.unwatch(event.resource)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// data was received, proceed it</span></span><br><span class="line">      consumeData(data)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>The resources was added to a data structure, associated with specific operation</li>
<li>The event notifier is set up with the group of resources to be watched. This call is synchronous and blocks until any of watched resource is ready for <code>read</code> operation. When the resource is ready for an operation the <code>event demultiplexer</code> returns from the call new set of events.</li>
<li>Each event is proceed. At this point, the resource associated with each event is guaranteed to be ready to processing and not to block during the operation. When all events are processed, the flow will be blocked again on the <code>event demultiplexer</code> until new events are again available to be proceed.</li>
</ol>
<blockquote>
<p>This is called the <code>event loop</code></p>
</blockquote>
<p>It’s interesting that with this pattern, we can now handle several I/O operation inside a single thread. How web-server will handle multiple requests using synchronous <code>event demultiplexer</code> with single thread:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/webserver-event-demultiplexer.png" title="" data-fancybox-group=""><img class="fig-img" src="images/webserver-event-demultiplexer.png" alt=""></a></div>
<h2 id="The_reactor_pattern"><a href="#The_reactor_pattern" class="headerlink" title="The reactor pattern"></a>The reactor pattern</h2><p>The main idea behind it is to have a handler (which in Node.js is represented by <code>callback</code> function) associated with each I/O operation, which will be invoked as soon as an event is produces and processed by <code>event loop</code>:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/reactor-pattern.png" title="" data-fancybox-group=""><img class="fig-img" src="images/reactor-pattern.png" alt=""></a></div>
<p>What’s happen when application use the <code>reactor patter</code>:</p>
<ol>
<li>The application generates a new I/O operation by submitting a request to <code>event demultiplexer</code>. Also application specified a handler, which will be invoked when the operation is completes. Submitting a new request is non-blocking call and it immediately returns control to the application</li>
<li>When set of I/O operation completes, the <code>event demultiplexer</code> pushes the new events into the <code>event loop</code></li>
<li>At this point, <code>event loop</code> iterates over the items of the <code>event queue</code></li>
<li>For each event, the associated handler is invoked</li>
<li><ul>
<li>(a) The handler which is a part of application code, will give control to <code>event loop</code> when it’s execution completes.</li>
<li>(b) However, new asynchronous operation might be requested during the execution of handler, causing new operation to registered in the <code>event demultiplexer</code>, before control is given back to <code>event loop</code></li>
</ul>
</li>
<li>When all items are processed in <code>event queue</code>, the loop will blocked again on <code>event demultiplexer</code> which will trigger another cycle of when a new events are available</li>
</ol>
<p>A Node.js application will exit automatically when there are no more pending operation in <code>event demultiplexer</code> and no more events to be processed in <code>event queue</code></p>
<blockquote>
<p><code>Pattern Reactor</code> handles I/O by blocking until new events are available from a set of observable resources and then reacts by dispatching each event with associated handler.</p>
</blockquote>
<h2 id="The_non-blocking_I/O_engine_of_Node-js-libuv"><a href="#The_non-blocking_I/O_engine_of_Node-js-libuv" class="headerlink" title="The non-blocking I/O engine of Node.js-libuv"></a>The non-blocking I/O engine of Node.js-libuv</h2><p>Each operation system has its own interface for the <code>event demultiplexer</code>. Besides that, each I/O operation can behave quite differently depending on type of resource, even within the same OS. All this inconsistencies required a higher abstraction for <code>event demultiplexer</code>.</p>
<p>This is exactly why Node.js core created a C library called <code>libuv</code> with objective to make Node.js compatible with all the major platform and normalize the non-blocking behavior of the different types of resource.</p>
<h2 id="The_building_blocks_of_Node-js_platform"><a href="#The_building_blocks_of_Node-js_platform" class="headerlink" title="The building blocks of Node.js platform"></a>The building blocks of Node.js platform</h2><p>The <code>reactor pattern</code> and <code>libuv</code> are the basic building blocks but we need the following three other components to build the full platform:</p>
<ul>
<li>a set of bindings responsible for wrapping and expose <code>libuv</code> and other low-level functionality to Javascript</li>
<li><code>V8</code> the Javascript engine, this one of the reason why Node.js is so fast and efficient</li>
<li>a <code>node-core</code> that implements the high-level Node.js API</li>
</ul>
<div class="figure center" style="width:;"><a class="fancybox" href="images/building-nodejs-blocks.png" title="" data-fancybox-group=""><img class="fig-img" src="images/building-nodejs-blocks.png" alt=""></a></div>
<h1 id="Chapter_2_3A_Node-js_essential_patterns"><a href="#Chapter_2_3A_Node-js_essential_patterns" class="headerlink" title="Chapter 2: Node.js essential patterns"></a>Chapter 2: Node.js essential patterns</h1><p>In this chapter, we’ll use two of the most important asynchronous patterns: <code>callback</code> and <code>event-emitter</code></p>
<h2 id="The_callback_pattern"><a href="#The_callback_pattern" class="headerlink" title="The callback pattern"></a>The callback pattern</h2><p>Callbacks are materialization of the handlers of the <code>reactor pattern</code>. Callback is a function that is invoked to propagate the result of an operation and this is exactly what we need when we dealing with asynchronous operation. Another ideal construct for implementing callbacks is <code>closure</code></p>
<h3 id="The_continue-passing_style"><a href="#The_continue-passing_style" class="headerlink" title="The continue-passing style"></a>The continue-passing style</h3><blockquote>
<p>In Javascript, a callback is a function that is passed as an argument to another function and is invoked with the result when operation is complete.</p>
</blockquote>
<p>Meanwhile,</p>
<blockquote>
<p>in function programming, this way of propagating the result is called <code>continuation-passing style</code> (CPS)</p>
</blockquote>
<p>To clarify the concept lets see a <code>direct style</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The equivalent <code>continue-passing style</code> would be as follow:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b, callback</span>) </span>&#123;</span><br><span class="line">  callback(a + b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Since <code>add()</code> is a synchronous <code>CPS</code> function the result will be:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'before'</span>);</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, result =&gt; <span class="built_in">console</span>.log(<span class="string">`Result <span class="subst">$&#123;result&#125;</span>`</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'after'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="comment">// Result 3</span></span><br><span class="line"><span class="comment">// after</span></span><br></pre></td></tr></table></figure>
<h3 id="Asynchronous_continue-passing_style"><a href="#Asynchronous_continue-passing_style" class="headerlink" title="Asynchronous continue-passing style"></a>Asynchronous continue-passing style</h3><p>Lets consider a case where the <code>add()</code> function is asynchronous:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAsync</span>(<span class="params">a, b, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(callback(a + b));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'before'</span>);</span><br><span class="line">addAsync(<span class="number">1</span>, <span class="number">2</span>, result =&gt; <span class="built_in">console</span>.log(<span class="string">`Result <span class="subst">$&#123;result&#125;</span>`</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'after'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="comment">// Result 3</span></span><br></pre></td></tr></table></figure>
<p>Since <code>setTimeout()</code> triggers an asynchronous operation, it won’t wait for the callback to be executed, but instead, it returns immediately, giving control back to <code>addAsync()</code> and then back to its caller. This is crucial and following image shows how it works:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/async-cps-in-action.png" title="" data-fancybox-group=""><img class="fig-img" src="images/async-cps-in-action.png" alt=""></a></div>
<p>The execution will start from the <code>event loop</code> so it will have a fresh stack. Thanks to <code>closure</code> it’s trivial to maintain the context of the caller in asynchronous function.</p>
<h3 id="Synchronous_or_asynchronous_3F"><a href="#Synchronous_or_asynchronous_3F" class="headerlink" title="Synchronous or asynchronous?"></a>Synchronous or asynchronous?</h3><p>The following is an analysis of these two paradigms and their pitfalls.</p>
<h4 id="An_unpredictable_function"><a href="#An_unpredictable_function" class="headerlink" title="An unpredictable function"></a>An unpredictable function</h4><p>One of the most dangerous situation is to have API that behaves synchronously under certain conditions and asynchronous under others:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> cache = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inconsistentRead</span>(<span class="params">filename, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (cache[filename]) &#123;</span><br><span class="line">    <span class="comment">// invoked synchronously</span></span><br><span class="line">    callback(cache[filename]);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// async call</span></span><br><span class="line">    fs.readFile(filename, <span class="string">'utf8'</span>, (err, data) =&gt; &#123;</span><br><span class="line">      cache[filename] = data;</span><br><span class="line">      callback(data);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Unleashing_Zalgo"><a href="#Unleashing_Zalgo" class="headerlink" title="Unleashing Zalgo"></a>Unleashing Zalgo</h4><p>Now lets see how to use an unpredictable function, such as to easily break an application:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFileReader</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listeners = [];</span><br><span class="line"></span><br><span class="line">  incosistentRead(filename, value =&gt; &#123;</span><br><span class="line">    listeners.forEach(listener =&gt; listener(value));</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    onDateReady: listener =&gt; listeners.push(listener)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When the preceding function is invoked, it creates a new object that acts as notifier, allowing us to set multiple listeners for a file read operation. All listeners will be invoked at once when the read operation completes and the data is available:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reader1 = createFileReader(<span class="string">'data.txt'</span>);</span><br><span class="line"></span><br><span class="line">reader1.onDateReady(data =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`First data call ready: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// same time letter we try to read the same file again</span></span><br><span class="line">  <span class="keyword">const</span> reader2 = createFileReader(<span class="string">'data.txt'</span>);</span><br><span class="line"></span><br><span class="line">  reader2.onDateReady(data =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Second data call ready: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The result output is: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">First data call ready: foo bar here!</span><br></pre></td></tr></table></figure>
<p>You can see the callback of the second operation is never invoked. Lets see why:</p>
<ol>
<li>During the creation of <code>reader1</code>, our <code>inconsistentRead()</code> function behaves asynchronously, because there isn’t cached result. Therefore, we have all time in the world to register our listener, as it will invoked later in another cycle of <code>event loop</code>, when the read operation is complete.</li>
<li>Then the <code>reader2</code> is created when requested file is in the cache. In this case the inner call of <code>inconsistentRead()</code> will be synchronous. So its call back will be invoked immediately, which mean that listener of <code>reader2</code> will be invoked synchronously as well. However, we registering the listeners after creation of <code>reader2</code>, so they will never be invoked!</li>
</ol>
<h3 id="Using_synchronous_APIs"><a href="#Using_synchronous_APIs" class="headerlink" title="Using synchronous APIs"></a>Using synchronous APIs</h3><p>One suitable fix for our <code>inconsistentRead()</code> function is to make it totally synchronous:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> cache = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">consistentRead</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (cache[filename]) &#123;</span><br><span class="line">    <span class="keyword">return</span> cache[filename];</span><br><span class="line">  &#125;</span><br><span class="line">  cache[filename] = fs.readFileSync(filename, <span class="string">'utf8'</span>);</span><br><span class="line">  <span class="keyword">return</span> cache[filename];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There is no reason for a function to have a continue-passing style it’s synchronous. In fact, it’s always a best practice to implement synchronous API using a <code>direct style</code>.</p>
<blockquote>
<p>Pattern:<br>Prefer <code>direct style</code> for purely synchronous function</p>
</blockquote>
<p>Bear in mind, that changing an API from <code>CPS</code> to a <code>direct style</code> (from asynchronous to synchronous or vice versa) require a change of style of all code using:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFileReader</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listeners = [];</span><br><span class="line">  <span class="keyword">const</span> fileData = consistentRead(filename)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    onDateReady: listener =&gt; &#123;</span><br><span class="line">      listeners.push(listener);</span><br><span class="line">      listeners.forEach(listener =&gt; listener(fileData));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Using_asynchronous_operation_with_deferred_execution"><a href="#Using_asynchronous_operation_with_deferred_execution" class="headerlink" title="Using asynchronous operation with deferred execution"></a>Using asynchronous operation with deferred execution</h3><p>The trick here is to schedule the synchronous callback invocation to be executed “in the future”, instead of being run immediately in the same event loop cycle. In Node.js this is possible using <code>process.nextTick()</code>, which defers the execution of a function until next the event loop cycle. This function is a very simple, it takes a callback and pushes it to the top of event queue, in front of any pending I/O event, and returns control immediately. So callback will run be invoked as soon as the event loop runs again.</p>
<p>Apply this technique to fix <code>inconsistentRead()</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> cache = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inconsistentRead</span>(<span class="params">filename, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (cache[filename]) &#123;</span><br><span class="line">    <span class="comment">// now invoked asynchronously</span></span><br><span class="line">    process.nextTick(() =&gt; callback(cache[filename]));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// async call</span></span><br><span class="line">    fs.readFile(filename, <span class="string">'utf8'</span>, (err, data) =&gt; &#123;</span><br><span class="line">      cache[filename] = data;</span><br><span class="line">      callback(data);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, our function is guaranteed to invoke its callback asynchronous, under any circumstances.</p>
<p>Another API for deferring the execution is <code>setImmediate()</code>. While their purposes are very similar, their semantics are quite different. Callback deferred with <code>process.nextTick()</code> run before any other I/O event fired, while with <code>setImmediate()</code>, the execution is queued behind any I/O event that is already in the queue. Since <code>process.nextTick()</code> runs before any already scheduled I/O, it might cause I/O starvation under certain circumstances, for example, a recursive invocation, this can never happen with <code>setImmediate()</code></p>
<blockquote>
<p>Pattern:<br>We guarantee that a callback is invoked asynchronously be deferring it execution using <code>process.nextTick()</code></p>
</blockquote>
<h3 id="Node-js_callback_convention"><a href="#Node-js_callback_convention" class="headerlink" title="Node.js callback convention"></a>Node.js callback convention</h3><p>CPS APIs and callbacks follows a set of specific convention.</p>
<h4 id="Callback_come_last"><a href="#Callback_come_last" class="headerlink" title="Callback come last"></a>Callback come last</h4><p>In all core Node.js methods, the standard convention is that when a function accept callback as input, this has to be passed as last parameter:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(filename[, options], callback)</span><br></pre></td></tr></table></figure>
<h4 id="Error_comes_first"><a href="#Error_comes_first" class="headerlink" title="Error comes first"></a>Error comes first</h4><p>In Node.js, any errors produced by a CPS function is always passed as first argument of the callback, and any actual result is passed starting from the second argument. It the operation is succeeds without errors, the first error will be <code>null</code> or <code>undefined</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(<span class="string">'foo.txt'</span>, <span class="string">'utf8'</span>, (err, data) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    handleError(err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    handleData(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="Propagation_errors"><a href="#Propagation_errors" class="headerlink" title="Propagation errors"></a>Propagation errors</h4><p>Propagation errors in synchronous, direct function is done with well-known <code>throw</code> statement.</p>
<p>In CPS style however, proper propagation is done by passing the error to the next callback in the chain:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readJson</span>(<span class="params">filename, callback</span>) </span>&#123;</span><br><span class="line">  fs.readFile(filename, <span class="string">'utf8'</span>, (err, data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> parsed;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="comment">// propagate the error and exit</span></span><br><span class="line">      <span class="keyword">return</span> callback(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      parsed = <span class="built_in">JSON</span>.parse(data);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">      <span class="comment">// catch parsing error</span></span><br><span class="line">      <span class="keyword">return</span> callback(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// no error propagate just data</span></span><br><span class="line">    callback(<span class="literal">null</span>, parsed);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="The_module_system_and_its_pattern"><a href="#The_module_system_and_its_pattern" class="headerlink" title="The module system and its pattern"></a>The module system and its pattern</h2><p>Modules are bricks for structuring non-trivial application, but also the main mechanism to enforce hiding information by keeping private all the function and variable that are not explicitly marked to be exported.</p>
<h3 id="The_revealing_module_pattern"><a href="#The_revealing_module_pattern" class="headerlink" title="The revealing module pattern"></a>The revealing module pattern</h3><p>Once of the major problem in Javascript is an absence of namespacing. A popular technique to solve this issue is called <code>the revealing module pattern</code>: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">module</span> = (() =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> privateFoo = () =&gt; &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> privateBar = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> exported = &#123;</span><br><span class="line">    publicFoo: <span class="string">'dataFoo'</span>,</span><br><span class="line">    publicBar: <span class="string">'dataBar'</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">export</span></span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure>
<p>We have a private scope and exporting only the parts that are meant to be public. As we’ll see at the moment, the idea behind this pattern is used as a base for a Node.js module system.</p>
<h3 id="Node-js_modules_explained"><a href="#Node-js_modules_explained" class="headerlink" title="Node.js modules explained"></a>Node.js modules explained</h3><p>CommonJS is a group with the aim to standardize the Javascript ecosystem, and one of their most popular proposal is <code>CommonJS module system</code>. Node.js built its module system on the top of this specification, with the addition of some custom extensions.</p>
<h4 id="A_homemade_module_loader"><a href="#A_homemade_module_loader" class="headerlink" title="A homemade module loader"></a>A homemade module loader</h4><p>To explain how Node.js modules work let’s built a similar system from scratch. The code mimics a subset of functionality of original <code>require</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">filename, module, require</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> wrappedSrc = <span class="string">`function(module, module, require) &#123;</span><br><span class="line">    <span class="subst">$&#123;fs.readFileSync(filename, 'utf8')&#125;</span></span><br><span class="line">  &#125;(module, module.exports, require)`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">eval</span>(wrappedSrc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bear in mind, that this code is only for example, feature such as <code>eval()</code> or <code>vm</code> <a href="https://nodejs.org/api/vm.html" target="_blank" rel="external">module</a> can be easily used in a wrong way or with a wrong input to inject attack. They should be used always with extreme care.</p>
<p>Now implementation of our <code>require()</code> function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">moduleName</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Require invoked for module: <span class="subst">$&#123;moduleName&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">require</span>.resolve(moduleName); <span class="comment">// [1]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">require</span>.cache[id]) &#123; <span class="comment">// [2]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">require</span>.cache[id].exports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// module metadata</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = &#123; <span class="comment">// [3]</span></span><br><span class="line">    exports: &#123;&#125;,</span><br><span class="line">    id</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// update the cache</span></span><br><span class="line">  <span class="built_in">require</span>.cache[id] = <span class="built_in">module</span>; <span class="comment">// [4]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load the module</span></span><br><span class="line">  loadModule(id, <span class="built_in">module</span>, <span class="built_in">require</span>); <span class="comment">// [5]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// return exported variables</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>.exports; <span class="comment">// [6]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>.cache = &#123;&#125;;</span><br><span class="line"><span class="built_in">require</span>.resolve = <span class="function"><span class="keyword">function</span>(<span class="params">moduleName</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// resolve a full module id from the moduleName</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What our homemade module system does is explain as follows:</p>
<ol>
<li>Module name is accepted as input, and the very first thing that we do is resolve the full path of module, and receive module <code>id</code>. It’s implementing by special resolving algorithm of <code>require.resolve()</code></li>
<li>If the module has already been loaded it should be available in the cache.</li>
<li>If the module hasn’t loaded yet, we set up environment for the first load. The property <code>module.exports</code> will be used to export public API.</li>
<li>The <code>module</code> object is cached.</li>
<li>The <code>loadModule()</code> code reads from its file, and the code is evaluated. We provide the module with <code>module</code> object that we just created, and a reference to <code>require()</code> function. The module exports its public API by manipulation or replacing the <code>module.exports</code> object.</li>
<li>Finally the content of <code>module.exports</code> is returned from caller.</li>
</ol>
<h4 id="Defining_a_modules"><a href="#Defining_a_modules" class="headerlink" title="Defining a modules"></a>Defining a modules</h4><p>By looking how us <code>require()</code> works be are able to define a module:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module.js</span></span><br><span class="line"><span class="comment">// load another module-dependency</span></span><br><span class="line"><span class="keyword">const</span> dependency = <span class="built_in">require</span>(<span class="string">'./anotherModule'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// private section</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">privateFoo</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the exported API</span></span><br><span class="line"><span class="built_in">module</span>.exports.run = <span class="function"><span class="keyword">function</span> <span class="title">publicBar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  privateFoo()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The essential concept to remember that everything in the module is private unless it’s assigned to <code>module.exports</code></p>
<h4 id="Defining_globals"><a href="#Defining_globals" class="headerlink" title="Defining globals"></a>Defining globals</h4><p>It’s still possible to define a global variable, in fact, module system exposes a special variable <code>global</code>, which can be used for this purpose</p>
<h4 id="u201Cmodule-exports_u201D_VS__u201Cexports_u201D"><a href="#u201Cmodule-exports_u201D_VS__u201Cexports_u201D" class="headerlink" title="“module.exports” VS “exports”"></a>“module.exports” VS “exports”</h4><p>A common source of confusion is the difference between using <code>module.exports</code> and <code>exports</code> to expose the public API. The code of our custom <code>require</code> function should again clear any doubts.</p>
<p>The variable <code>exports</code> is just a reference to initial value of <code>module.exports</code>, essentially it’s an empty object before the module is loaded. This means that we can only attach new properties referencing by <code>exports</code> variable:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exports.hello = () =&gt; &#123; <span class="built_in">console</span>.log(<span class="string">'Hello'</span>) &#125;;</span><br></pre></td></tr></table></figure>
<p>Reassigning the <code>exports</code> variable doesn’t have any sense, because it doesn’t change content of <code>module.exports</code>. That’s how object in Javascript works. The following code therefore is wrong:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exports.hello = () =&gt; &#123; <span class="built_in">console</span>.log(<span class="string">'Hello'</span>) &#125;;</span><br></pre></td></tr></table></figure>
<p>If we want to export something other than an object literal, we can reassigning <code>module.exports</code> as follow:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = () =&gt; &#123; <span class="built_in">console</span>.log(<span class="string">'Hello'</span>) &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="The__u201Crequire_u201D_function_is_synchronous"><a href="#The__u201Crequire_u201D_function_is_synchronous" class="headerlink" title="The “require” function is synchronous"></a>The “require” function is synchronous</h4><p>We should take into account that our homemade <code>require</code> is synchronous. In fact, it returns the module contents using simple direct style therefore no callback is required. This is true for original Node.js <code>require</code> function too. As a consequence any assignments to <code>module.exports</code> must be synchronous. The following code is incorrect:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = () =&gt; &#123;&#125;</span><br><span class="line">&#125;, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>This is one of the important reasons why Node.js libraries offer synchronous APIs as alternative to asynchronous ones.</p>
<h4 id="The_resolving_algorithm"><a href="#The_resolving_algorithm" class="headerlink" title="The resolving algorithm"></a>The resolving algorithm</h4><p>Node.js solver the <code>dependency hell</code> elegantly by loading different version of module depending on where the module is loaded from. As we saw the <code>resolve()</code> function takes a module name (<code>moduleName</code> in our loader) as input, and it returns the full path of module. This path is used to load its code and to identify the module uniquely.</p>
<p>The resolving algorithm can be divided into the following three major branches:</p>
<ul>
<li>file modules</li>
<li>core modules</li>
<li>package modules</li>
</ul>
<p>The resolving algorithm can be be found at <a href="https://nodejs.org/api/modules.html#modules_all_together" target="_blank" rel="external">official spec</a>.</p>
<p>The <code>node_modules</code> directory is where <code>npm</code> installs the dependencies of each package. Based on the algorithm, each package can have its own private dependencies. Consider the following structure:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">myApp</span><br><span class="line">├── foo<span class="selector-class">.js</span></span><br><span class="line">└── node_modules</span><br><span class="line">    ├── depA</span><br><span class="line">    │   └── index<span class="selector-class">.js</span></span><br><span class="line">    ├── depB</span><br><span class="line">    │   ├── bar<span class="selector-class">.js</span></span><br><span class="line">    │   └── node_modules</span><br><span class="line">    │       └── depA</span><br><span class="line">    │           └── index<span class="selector-class">.js</span></span><br><span class="line">    └── depC</span><br><span class="line">        ├── foobar<span class="selector-class">.js</span></span><br><span class="line">        └── node_modules</span><br><span class="line">            └── depA</span><br><span class="line">            └── index.js</span><br></pre></td></tr></table></figure>
<p>Following rules of resolving algorithm, using <code>require(&#39;depA&#39;)</code> will load a different file depending on the module that requires it:</p>
<ul>
<li>Calling <code>require(&#39;depA&#39;)</code> from <code>/myApp/foo.js</code> will load <code>/myApp/node_modules/depA/index.js</code></li>
<li>Calling <code>require(&#39;depA&#39;)</code> from <code>/myApp/node_modules/depB/bar.js</code> will load <code>/myApp/node_modules/depB/node_modules/depA/index.js</code></li>
<li>Calling <code>require(&#39;depA&#39;)</code> from <code>/myApp/node_modules/depC/foobar.js</code> will load <code>/myApp/node_modules/depc/node_modules/depA/index.js</code></li>
</ul>
<h4 id="The_module_cache"><a href="#The_module_cache" class="headerlink" title="The module cache"></a>The module cache</h4><p>Each module is only loaded and evaluated the first time it’s required, since any subsequent call of <code>require()</code> will return the cached version. Again, it should be clear by looking at the code of homemade <code>require()</code> function.</p>
<p>The module cache is exposed via the <code>require.cache</code> reference, so it’s possible to directly access it if needed.</p>
<h3 id="Module_definition_patterns"><a href="#Module_definition_patterns" class="headerlink" title="Module definition patterns"></a>Module definition patterns</h3><p>The module system besides being a mechanism for loading dependencies, is also a tool for defining APIs. To aim is to maximize information hading and API usability, with balancing with other software quality such as <code>code reuse</code> and <code>extensibility</code>.</p>
<h4 id="Named_exports"><a href="#Named_exports" class="headerlink" title="Named exports"></a>Named exports</h4><p>The most basic method for exposing public API is using <code>named exports</code>, which consist to assignment all the public values to object referenced by <code>exports</code> or <code>module.exports</code>. Most of the Node.js core modules use this pattern.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file logger.js</span></span><br><span class="line">exports.info = (msg) = &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`info: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.verbose = (msg) = &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`verbose: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file main.js</span></span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'./logger'</span>);</span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">'Info massage'</span>);</span><br><span class="line">logger.verbose(<span class="string">'Verbose massage'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Exporting_a_function"><a href="#Exporting_a_function" class="headerlink" title="Exporting a function"></a>Exporting a function</h4><p>One of the most popular module definition pattern consists of reassigning of the whole <code>module.exports</code> variable to the function. The main goal to provide a clear entry point for the module, making it simpler to understand and use. It also honors the principle of <code>small area surface</code>. This way of defining modules also is known as the <code>substack pattern</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file logger.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = (msg) = &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`info: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>A possible extension for this pattern is using the exported function as namespace for other public APIs. This is a very powerful technique, because it still gives clarity of a single entry point.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the same file logger.js</span></span><br><span class="line"><span class="built_in">module</span>.exports.verbose = (msg) = &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`verbose: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file main.js</span></span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'./logger'</span>);</span><br><span class="line"></span><br><span class="line">logger(<span class="string">'Info massage'</span>);</span><br><span class="line">logger.verbose(<span class="string">'Verbose massage'</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Pattern:<br>Substack or Single Responsibility Principle (SRP)<br>Expose the main functionality of a module by exporting only one function. Use the exported function as a namespace to expose any auxiliary functionality</p>
</blockquote>
<h4 id="Exporting_a_constructor"><a href="#Exporting_a_constructor" class="headerlink" title="Exporting a constructor"></a>Exporting a constructor</h4><p>The difference is with this approach we allow user to create a new instance using the constructor with ability to extend its prototype and forge new classes.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file logger.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  log(msg) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[<span class="subst">$&#123;this.name&#125;</span>] <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  info(msg) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`info: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  verbose(msg) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`info: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Logger;</span><br></pre></td></tr></table></figure>
<p>A variation of this pattern consists of applying a security check against invocation that doesn’t use <code>new</code> directive. This a little trick allows us to use our module as <code>factory</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoggerFactory</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span> <span class="keyword">instanceof</span> Logger) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Logger(name)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Logger(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A much cleaner approach is offered by ES6 <code>new.targer</code> which is available starting from Node.js v6. The syntax expose the <code>new.targer</code> which is called <code>meta property</code>, made available inside all the function, end evaluates to true at runtime if the function was called using the <code>new</code> directive.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoggerFactory</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">new</span>.target) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Logger(name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Logger(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exporting_an_instance"><a href="#Exporting_an_instance" class="headerlink" title="Exporting an instance"></a>Exporting an instance</h4><p>We can leverage the caching mechanism of <code>require()</code> to define stateful instance with a state created from a constructor or factory, shared across different modules:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file logger.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  log(msg) &#123;</span><br><span class="line">    <span class="keyword">this</span>.count++;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[<span class="subst">$&#123;this.name&#125;</span>] <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> Logger(<span class="string">'default'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// file main.js</span></span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'./logger.js'</span>);</span><br><span class="line">logger.log(<span class="string">'test the singleton'</span>);</span><br></pre></td></tr></table></figure>
<p>This is much like a <code>singleton pattern</code>, however it doesn’t guarantee the uniqueness of the instance across the whole application, as it happens with traditional singleton pattern. When analyzing the resolving algorithm, we have seen in fact, that a module might be installed multiple times inside the dependency tree of an application.</p>
<h4 id="Modifying_other_modules_or_the_global_scope"><a href="#Modifying_other_modules_or_the_global_scope" class="headerlink" title="Modifying other modules or the global scope"></a>Modifying other modules or the global scope</h4><p>A module can even export nothing. We should not forger that module can modify the global scope and the object in it, including other modules in the cache. In general it’s considering as a bad practice.</p>
<blockquote>
<p>Pattern:<br>Monkey patching is when module can modify other modules or object in global scope. It change the existing objects at runtime to change or extend their behavior or apply temporary fixes</p>
</blockquote>
<p>How we can add a new function to another module:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file patcher.js</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./logger'</span>).customMessage = () =&gt; <span class="built_in">console</span>.log(<span class="string">'this is a new functionality'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./patcher'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'./logger'</span>);</span><br><span class="line">logger.customMessage();</span><br></pre></td></tr></table></figure>
<p>The technique is dangerous, because it affects the state of entire app.</p>
<h2 id="The_observer_pattern"><a href="#The_observer_pattern" class="headerlink" title="The observer pattern"></a>The observer pattern</h2><p>Together with the <code>reactor</code>, <code>callbacks</code> and <code>modules</code>, the <code>observer pattern</code> is one of the pillars of the platform and is used by mane Node.js core and user-land modules.</p>
<blockquote>
<p>Pattern Observer:<br>Defines an object (subject), which can notify a set of observers (listeners) when change is occur.</p>
</blockquote>
<p>The main difference from the callback pattern is that the <code>subject</code> can notify multiple observers, while a traditional <code>CPS</code> will propagate its result to only one listener, the callback.</p>
<h3 id="The_EventEmitter_class"><a href="#The_EventEmitter_class" class="headerlink" title="The EventEmitter class"></a>The EventEmitter class</h3><p>The observer pattern built into core and it’s available through the <code>EventEmitter</code> class. It allows to register one or multiple function as <code>listeners</code>, which will be notified when a particular event type is fired. The following explains the concept:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/event-emitter.png" title="" data-fancybox-group=""><img class="fig-img" src="images/event-emitter.png" alt=""></a></div>
<p>How to require <code>EventEmitter</code> from core <code>events</code> module:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">const</span> eeInstance = <span class="keyword">new</span> EventEmitter;</span><br></pre></td></tr></table></figure>
<p>The API is in <a href="https://nodejs.org/api/events.html#events_class_eventemitter" target="_blank" rel="external">official Node.js specification</a>.</p>
<p>We can already see that there is a big difference between a listener and a traditional Node.js callback, in particular, the first argument isn’t an error, but any data which is passed to <code>emit()</code> at the moment of invocation.</p>
<h3 id="Creating_and_using_EventEmitter"><a href="#Creating_and_using_EventEmitter" class="headerlink" title="Creating and using EventEmitter"></a>Creating and using EventEmitter</h3><p>The following code shows a function that uses <code>EventEmitter</code> to notify its subscribers in real time when a particular pattern is found in a list of files:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPattern</span>(<span class="params">files, regexp</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> emitter = <span class="keyword">new</span> EventEmitter;</span><br><span class="line"></span><br><span class="line">  files.forEach(file =&gt; &#123;</span><br><span class="line">    fs.readFile(file, <span class="string">'utf8'</span>, (err, content) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> match;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        emitter.emit(<span class="string">'error'</span>, err);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      emitter.emit(<span class="string">'fileread'</span>, file); </span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (match = content.match(regexp)) &#123;</span><br><span class="line">        match.forEach(elem =&gt; emitter.emit(<span class="string">'found'</span>, file, elem))        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lets see how <code>findPattern</code> can be used:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">findPattern(</span><br><span class="line">  [<span class="string">'data1.txt'</span>, <span class="string">'data2.txt'</span>],</span><br><span class="line">  <span class="regexp">/foo \w+/g</span></span><br><span class="line">)</span><br><span class="line">  .on(<span class="string">'fileread'</span>, file =&gt; <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;file&#125;</span> was read`</span>))</span><br><span class="line">  .on(<span class="string">'found'</span>, (file, match) =&gt; <span class="built_in">console</span>.log(<span class="string">`matched <span class="subst">$&#123;match&#125;</span> in file <span class="subst">$&#123;file&#125;</span>`</span>))</span><br><span class="line">  .on(<span class="string">'error'</span>, err =&gt; <span class="built_in">console</span>.log(<span class="string">`Error: <span class="subst">$&#123;err&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>
<h3 id="Extends_from_EventEmitter_class"><a href="#Extends_from_EventEmitter_class" class="headerlink" title="Extends from EventEmitter class"></a>Extends from EventEmitter class</h3><p>To demonstrate the pattern lets implement the functionality of the <code>findPattern()</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FindPattern</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(regexp) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.regexp = regexp;</span><br><span class="line">    <span class="keyword">this</span>.files = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addFile(file) &#123;</span><br><span class="line">    <span class="keyword">this</span>.files.push(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  find() &#123;</span><br><span class="line">    <span class="keyword">this</span>.files.forEach(file =&gt; &#123;</span><br><span class="line">      fs.readFile(file, <span class="string">'utf8'</span>, (err, content) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> match;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'fileread'</span>, content); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (match = content.match(<span class="keyword">this</span>.regexp)) &#123;</span><br><span class="line">          match.forEach(elem =&gt; <span class="keyword">this</span>.emit(<span class="string">'found'</span>, file, elem); )        </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>FindPattern</code> prototype extends <code>EventEmitter</code>. In this way it becomes a fully-fledged observable class. The usage:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> findPatternObj = <span class="keyword">new</span> FindPattern(<span class="regexp">/hello \w+/g</span>);</span><br><span class="line"></span><br><span class="line">findPatternObj</span><br><span class="line">  .addFile(<span class="string">'data1.txt'</span>)</span><br><span class="line">  .addFile(<span class="string">'data2.txt'</span>)</span><br><span class="line">  .on(<span class="string">'fileread'</span>, file =&gt; <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;file&#125;</span> was read`</span>))</span><br><span class="line">  .on(<span class="string">'found'</span>, (file, match) =&gt; <span class="built_in">console</span>.log(<span class="string">`matched <span class="subst">$&#123;match&#125;</span> in file <span class="subst">$&#123;file&#125;</span>`</span>))</span><br><span class="line">  .on(<span class="string">'error'</span>, err =&gt; <span class="built_in">console</span>.log(<span class="string">`Error: <span class="subst">$&#123;err&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>
<p>This is a pretty common pattern in the Node.js ecosystem, for example, the <code>Server</code> object of the core HTTP module defines methods such as <code>listen()</code>, <code>close()</code>, <code>setTimeout()</code> and internally it inherits from the <code>EventEmitter</code> function. It allows to produce events such as <code>request</code> when a new connection is received, or <code>connection</code> when a new connection is established, or <code>close</code> when server is shut down.</p>
<h3 id="Combining_callbacks_with_EventEmitter"><a href="#Combining_callbacks_with_EventEmitter" class="headerlink" title="Combining callbacks with EventEmitter"></a>Combining callbacks with EventEmitter</h3><p>There are also circumstances where <code>EventEmitter</code> can be combining with a <code>callback</code>. One example of this pattern is offered by the <code>node-glob</code> module, which performs a glob-style searching. The function <code>glob(pattern, [options], callback)</code> takes a <code>callback</code> that is invoked with the list of all files which are matched by the providing pattern. At the same time it returns <code>EventEmitter</code> that provides an interface to report over the state of the process:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">'glob'</span>);</span><br><span class="line"></span><br><span class="line">glob(<span class="string">'*.txt'</span>, (err, files) =&gt; <span class="built_in">console</span>.log(<span class="string">`Founded files: <span class="subst">$&#123;JSON.stringify(files)&#125;</span>`</span>))</span><br><span class="line">  .on(<span class="string">'match'</span>, match =&gt; <span class="built_in">console</span>.log(<span class="string">`Matched files: <span class="subst">$&#123;match&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>
<h1 id="Chapter_3_3A_Asynchronous_control_flow_patterns_with_callbacks"><a href="#Chapter_3_3A_Asynchronous_control_flow_patterns_with_callbacks" class="headerlink" title="Chapter 3: Asynchronous control flow patterns with callbacks"></a>Chapter 3: Asynchronous control flow patterns with callbacks</h1><p>One of the common mistake is to fail into the trap of the callback hell and see how the code is growing horizontally rather than vertically, with the nesting which makes even simple routine hard to read and maintain.</p>
<p>In this chapter we we’ll see how it’s actually possible to tame callbacks and write clean, manageable asynchronous code with the aid of some patterns.</p>
<h2 id="Creating_a_simple_web_spider"><a href="#Creating_a_simple_web_spider" class="headerlink" title="Creating a simple web spider"></a>Creating a simple web spider</h2><p>To explain the problem we’ll create a little CLI application that takes a web URL as input and downloads its contents locally into file.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file spider.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>); <span class="comment">// HTTP request client</span></span><br><span class="line"><span class="keyword">const</span> mkdirp = <span class="built_in">require</span>(<span class="string">'mkdirp'</span>); <span class="comment">// Recursively mkdir, like mkdir -p</span></span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>); <span class="comment">// Terminal string styling done right.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">'./utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">spider</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = utils.urlToFilePath(url);</span><br><span class="line">  <span class="keyword">const</span> fileName = utils.urlToFileName(url);</span><br><span class="line">  <span class="keyword">let</span> isFileExists = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  fs.stat(filePath, (err, stats) =&gt; &#123; <span class="comment">// [1]</span></span><br><span class="line">    <span class="keyword">if</span> (stats) &#123;</span><br><span class="line">      cb(<span class="literal">null</span>, fileName, isFileExists = <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      request(url, (err, response, body) =&gt; &#123; <span class="comment">// [2]</span></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          cb(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          mkdirp(filePath, err =&gt; &#123; <span class="comment">// [3]</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              cb(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              fs.writeFile(path.join(filePath, fileName), body, err =&gt; &#123; <span class="comment">// [3]</span></span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                  cb(err);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  cb(<span class="literal">null</span>, fileName, isFileExists);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spider(process.argv[<span class="number">2</span>], (err, fileName, fileExists) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chalk.red(<span class="string">`Error: <span class="subst">$&#123;err&#125;</span>`</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fileExists) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chalk.blue(<span class="string">`File: <span class="subst">$&#123;fileName&#125;</span> exists`</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chalk.green(<span class="string">`File: <span class="subst">$&#123;fileName&#125;</span> is downloaded`</span>));</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// file utils.js</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line">* Converts urls to simplified strings</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">const</span> slugifyUrl = <span class="built_in">require</span>(<span class="string">'slugify-url'</span>);</span><br><span class="line"></span><br><span class="line">exports.urlToFilePath = urlToFilePath;</span><br><span class="line">exports.urlToFileName = urlToFileName;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlToFilePath</span>(<span class="params">url</span>) </span>&#123; <span class="comment">// http://example.com/bar</span></span><br><span class="line">  <span class="keyword">const</span> slashChar = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> slugifyUrl(url, &#123; slashChar &#125;); <span class="comment">// example.com/bar</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlToFileName</span>(<span class="params">url</span>) </span>&#123; <span class="comment">// http://example.com/bar</span></span><br><span class="line">  <span class="keyword">const</span> slashChar = <span class="string">'/'</span>;</span><br><span class="line">  <span class="keyword">const</span> parsedUrl = slugifyUrl(url, &#123; slashChar &#125;).split(<span class="string">'/'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> parsedUrl[parsedUrl.length - <span class="number">1</span>]; <span class="comment">// bar</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The preceding functions execute the following tasks:</p>
<ol>
<li>Check if the URL was already downloaded by verifying that corresponding file hasn’t already created.</li>
<li>If the file is not found, it would download content of provided URL</li>
<li>Than it crates recursively directories</li>
<li>Finally, it writes the body of HTTP response to file system</li>
</ol>
<h2 id="The_callback_hell"><a href="#The_callback_hell" class="headerlink" title="The callback hell"></a>The callback hell</h2><p>We can surely notice that even though the algorithm was straightforward, the resulting code has several level of indentation and it’s very hard to read. Implementing a similar function in <code>direct style</code> would more straightforward, and it would be very few chances to make it look so wrong. However, using <code>CPS</code> is another story, and making bad use of closure may lead to to incredible bad code.</p>
<p>That’s known as <code>callback hell</code> or <code>piramid of domm</code>. The typical structure of code affected by the problem looks like the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">asyncFoo(err =&gt; &#123;</span><br><span class="line">  asyncBar(err2 =&gt; &#123;</span><br><span class="line">    asyncFooBar(err3 =&gt; &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Another problem is caused by overlapping of the variable names used in each scope. Some people try to avoid it with variation of variables <code>error, err, err2</code>.</p>
<p>Also we should keep in mind that closure can create memory leaks that are not so easy to identify. We shouldn’t forget that any context referenced by an active closure is retained from garbage collector.</p>
<h1 id="Applying_the_callback_discipline"><a href="#Applying_the_callback_discipline" class="headerlink" title="Applying the callback discipline"></a>Applying the callback discipline</h1><p>Basic principles that can help to keep the nesting level low and improve the organization of our code in general:</p>
<ul>
<li>you must exit as soon as possible. Use <code>return</code>, <code>continue</code> or <code>break</code>, depending on context to immediately exit the current statement</li>
<li>create a named function for callbacks. Will keep our code shallow and better look for stack trace</li>
<li>modularize the code. Create a small, reusable function whenever it’s possible</li>
</ul>
<p>After applying the following recommendation our <code>spider()</code> would look as following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">spider</span>(<span class="params">url, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = utils.urlToFilePath(url);</span><br><span class="line">  <span class="keyword">const</span> fileName = utils.urlToFileName(url);</span><br><span class="line">  <span class="keyword">let</span> isFileExists = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  fs.stat(filePath, (err, stats) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (stats) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(<span class="literal">null</span>, fileName, isFileExists = <span class="literal">true</span>); <span class="comment">// [!]</span></span><br><span class="line">    &#125;</span><br><span class="line">    download(url, filePath, fileName, isFileExists, cb);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params">url, filePath, fileName, isFileExists, cb</span>) </span>&#123;</span><br><span class="line">  request(url, (err, response, body) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err); <span class="comment">// [!]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      saveFile(filePath, fileName, body, isFileExists, cb); <span class="comment">// [!]</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveFile</span>(<span class="params">filePath, fileName, content, isFileExists, cb</span>) </span>&#123;</span><br><span class="line">  mkdirp(filePath, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err); <span class="comment">// [!]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      writeContent(filePath, fileName, content, isFileExists, cb);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeContent</span>(<span class="params">filePath, fileName, content, isFileExists, cb</span>) </span>&#123;</span><br><span class="line">  fs.writeFile(path.join(filePath, fileName), content, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err); <span class="comment">// [!]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(<span class="literal">null</span>, fileName, isFileExists); <span class="comment">// [!]</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sequential_execution"><a href="#Sequential_execution" class="headerlink" title="Sequential execution"></a>Sequential execution</h2><p>Executing a set of task in sequence means running them one at time, one ofter other. The order of execution matters. The concept:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/sequential-execution.png" title="" data-fancybox-group=""><img class="fig-img" src="images/sequential-execution.png" alt=""></a></div>
<p>There are different variation of this flow:</p>
<ul>
<li><code>execution a set of known task in sequence</code>, without chaining and propagate the result</li>
<li>using output of task as the input to the next task, also known as <code>chain</code>, <code>pipe</code>, or <code>waterfall</code></li>
<li>iterating over a collection while running an asynchronous task on each element, one ofter other</li>
</ul>
<h3 id="Execution_a_set_of_known_task_in_sequence"><a href="#Execution_a_set_of_known_task_in_sequence" class="headerlink" title="Execution a set of known task in sequence"></a>Execution a set of known task in sequence</h3><p>We’ve already met a sequential execution while implementing the <code>spider()</code> function. Taking that code as guideline we can generalize the solution into the following pattern:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">task1</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">  asyncOperation(() =&gt; task2(cb))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">task2</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">  asyncOperation(() =&gt; task3(cb))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">task3</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">  asyncOperation(() =&gt; cb()) <span class="comment">// finally executes the callback</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncOperation</span>(<span class="params">cb</span>) </span>&#123; <span class="comment">// emulates asynchronous operation</span></span><br><span class="line">  setTimeout(() =&gt; cb());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task1(() =&gt; <span class="built_in">console</span>.log(<span class="string">'task 1, 2 and 3 executed'</span>));</span><br></pre></td></tr></table></figure>
<h3 id="Sequential_iteration_with_crawling_of_links"><a href="#Sequential_iteration_with_crawling_of_links" class="headerlink" title="Sequential iteration with crawling of links"></a>Sequential iteration with crawling of links</h3><p>What if we want to invoke an asynchronous operation for each file in a collection?</p>
<p>With new feature, downloading all the links contained in the web-page recursively. To do that, we are going to extract all links from the page and than trigger our web spider on each of them recursively and in sequence.</p>
<p>The new version of <code>spider()</code> is as following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">spider</span>(<span class="params">url, nesting, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> filename = utilities.urlToFilename(url);</span><br><span class="line">  fs.readFile(filename, <span class="string">'utf8'</span>, (err, body) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(err) &#123;</span><br><span class="line">      <span class="keyword">if</span>(err.code ! == <span class="string">'ENOENT'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(err);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> download(url, filename, (err, body) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(err) &#123;</span><br><span class="line">          <span class="keyword">return</span> callback(err);</span><br><span class="line">        &#125;</span><br><span class="line">        spiderLinks(url, body, nesting, callback);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spiderLinks(url, body, nesting, callback);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">spiderLink</span>(<span class="params">url, body, nesting, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (nesting === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> process.nextTick(cb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// require('get-urls')</span></span><br><span class="line">  <span class="keyword">const</span> links = utils.getUrls(body); <span class="comment">// [1]</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">iterate</span>(<span class="params">index</span>) </span>&#123; <span class="comment">// [2]</span></span><br><span class="line">    <span class="keyword">if</span> (index === links.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spider(links[index], nesting - <span class="number">1</span>, err =&gt; &#123; <span class="comment">// [3]</span></span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> cb(err);</span><br><span class="line">      &#125;</span><br><span class="line">      iterate(index - <span class="number">1</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  iterate(<span class="number">0</span>); <span class="comment">// [4]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The important steps to understand:</p>
<ol>
<li>Obtain the list of all links on the page using the <code>utils.getUrls()</code>. This links should return only with the same hostname</li>
<li>Iterate through links via local function <code>iterate()</code>. The first thing it checks if the <code>index</code> is equal to the length of <code>links</code>, in which case it immediately invokes the <code>cb()</code> as it means it proceeds all items</li>
<li>At this point everything is ready to processing the links. It invokes the <code>spider()</code> function by decreasing the nesting level and invoking the next step of iteration then the operation is complete</li>
<li>It’s a bootstrapping the iteration by <code>iterate(0)</code></li>
</ol>
<h3 id="The_pattern__u201Csequential_iteration_u201D"><a href="#The_pattern__u201Csequential_iteration_u201D" class="headerlink" title="The pattern “sequential iteration”"></a>The pattern “sequential iteration”</h3><p>It can be generalize as follow:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iterate</span>(<span class="params">index</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index === tasks.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> finish();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> task = tasks[index];</span><br><span class="line">  task(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    iterate(index + <span class="number">1</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finish</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// iteration completed</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">iterate(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>It’s important to notice that these type of algorithm become really recursive if <code>task()</code> is an asynchronous operation. In such a case there might be a risk of hitting the maximum call stack limit.</p>
<blockquote>
<p>Pattern sequential iterator:<br>execute a list of tasks in sequence by creating a function <code>iterate()</code> which invokes the next available task in the collection and makes sure to invoke next step of iteration when the current task is completed</p>
</blockquote>
<h2 id="Parallel_execution"><a href="#Parallel_execution" class="headerlink" title="Parallel execution"></a>Parallel execution</h2><p>There is some situation when the order of execution of the set of asynchronous tasks is not important and we want just to be notified when all these running tasks are completed.</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/parallel-execution.png" title="" data-fancybox-group=""><img class="fig-img" src="images/parallel-execution.png" alt=""></a></div>
<p>#<br>We realize that even thought we have one thread we can still achieve <code>concurrency</code>, thanks to not-blocking nature of Node.js. In fact, the word <code>parallel</code> is used improperly in this case, as it doesn’t mean that the task run simultaneously, but rather their execution is carried out by an underlying non-blocking API and invoked by the event loop.</p>
<p>As we know, a task gives control back to the event loop when it request a new asynchronous operation, allowing the event loop to execute another task. The proper word is to use for this kind of flow is <code>concurrency</code>, but we still use parallel for simplicity sake.</p>
<p>The following diagram shows how two asynchronous tasks can run in parallel in a Node.js program:</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/parallel-execution-diagram.png" title="" data-fancybox-group=""><img class="fig-img" src="images/parallel-execution-diagram.png" alt=""></a></div>
<p>We have <code>Main</code> function that executes two asynchronous tasks:</p>
<ol>
<li>The <code>Main</code> function triggers the execution of <code>Task1</code> and <code>Task2</code>. As they are asynchronous operations the immediately return control to <code>Main</code>, which then returns to <code>event loop</code></li>
<li>When the asynchronous operation of <code>Task1</code> is completed, the <code>event loop</code> gives control to it. When <code>task1</code> completes the internal synchronous operation processing as well, it notifies the <code>Main</code></li>
<li>The same as described in p2 but now with <code>event loop</code> triggers the <code>Task2</code>. At this point <code>Main</code> function knows that <code>Task1</code> and <code>Task2</code> are completed, so it can continue the execution or return the result of the operation to another callback.</li>
</ol>
<h3 id="Execution_with__u201CspiderLinks_u201D"><a href="#Execution_with__u201CspiderLinks_u201D" class="headerlink" title="Execution with “spiderLinks”"></a>Execution with “spiderLinks”</h3><p>So far application is executing the recursive download of the linked pages in a sequential fashion. We can easily improve performance of this process by downloading all the linked pages in parallel:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">spiderLink</span>(<span class="params">url, body, nesting, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (nesting === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> process.nextTick(cb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> links = utils.getUrls(body);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (links.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> process.nextTick(cb)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> completed = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> hasErrors = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      hasErrors = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">return</span> cb(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (++completed === links.length &amp;&amp; !hasErrors) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  links.forEach(link =&gt; &#123;</span><br><span class="line">    spider(link, nesting - <span class="number">1</span>, done);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The trick to make our application to wait for all the task to complete is to invoke the <code>spider()</code> with a special callback <code>done()</code>. The <code>done()</code> increases a counter when a <code>spider()</code> task completes. When the number of completed downloads reaches the size of <code>links[]</code>, the final callback is invoked.</p>
<h3 id="The_pattern__u201Cunlimited_parallel_execution_u201D"><a href="#The_pattern__u201Cunlimited_parallel_execution_u201D" class="headerlink" title="The pattern “unlimited parallel execution”"></a>The pattern “unlimited parallel execution”</h3>
            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/">...</a> <a class="tag tag--primary tag--small t-link" href="/tags/Javascript/">Javascript</a> <a class="tag tag--primary tag--small t-link" href="/tags/Node-js/">Node.js</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/09/28/Gulp-screencast-overview/" data-tooltip="Gulp screencast overview">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Orest Prystayko. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/09/28/Gulp-screencast-overview/" data-tooltip="Gulp screencast overview">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/35948c039f71fe48d765768c07bfee67?s=110"/>
        
            <h4 id="about-card-name">Orest Prystayko</h4>
        
            <h5 id="about-card-bio"><p>I try to learn something new every day. It may relate to personal finances, physical health, algorithms, computer programming. And the learning process might take place for a few minutes or from sunrise to sunset. I bealive that every time when I achieve new knowledge, I tipically observe how increase my quality of live.</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Front End Developer @ Eleks</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Ukraine, Lviv
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover-v2.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script-ppchwyfgucduw3ojfh1i853ih960qxole5o4s9sa9frxvrvotx4v6idldx5r.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://qetr1ck-op.github.io/2016/10/06/Node-js-design-pattern-book-review/';
                 
                    this.page.identifier = '2016/10/06/Node-js-design-pattern-book-review/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'qetr1ck-op';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','yjp7PCgxKmcfHTQ63jfa','2.0.0');
    </script>


</html>
