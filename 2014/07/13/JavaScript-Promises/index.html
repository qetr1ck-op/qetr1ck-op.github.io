
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Blog | qetr1ck-op">
    <title>JavaScript Promises - Blog | qetr1ck-op</title>
    <meta name="author" content="Orest Prystayko">
    
        <link rel="icon" href="/assets/images/favicon.ico">
    
    
    <meta name="description" content="Table of ContentsPromises arrive in JavaScript!Promisifying XMLHttpRequestChainingError handlingCreating a sequence
Promises arrive in JavaScript!Here’s how you create a promise:
12345678910var promis">
<meta property="og:type" content="blog">
<meta property="og:title" content="JavaScript Promises">
<meta property="og:url" content="http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/index.html">
<meta property="og:site_name" content="Blog | qetr1ck-op">
<meta property="og:description" content="Table of ContentsPromises arrive in JavaScript!Promisifying XMLHttpRequestChainingError handlingCreating a sequence
Promises arrive in JavaScript!Here’s how you create a promise:
12345678910var promis">
<meta property="og:image" content="http://www.html5rocks.com/en/tutorials/es6/promises/promise1.gif">
<meta property="og:image" content="http://www.html5rocks.com/en/tutorials/es6/promises/promise2.gif">
<meta property="og:updated_time" content="2016-01-31T22:55:40.409Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScript Promises">
<meta name="twitter:description" content="Table of ContentsPromises arrive in JavaScript!Promisifying XMLHttpRequestChainingError handlingCreating a sequence
Promises arrive in JavaScript!Here’s how you create a promise:
12345678910var promis">
<meta name="twitter:creator" content="@https://twitter.com/oprystayko">
    
    
    
        <meta property="og:image" content="http://www.gravatar.com/avatar/35948c039f71fe48d765768c07bfee67?s=640"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Blog | qetr1ck-op</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="/#search">
        
                <i class="fa fa-lg fa-search"></i>
            </a>
    
</header>
            <nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                
                    <img class="sidebar-profile-picture" src="http://www.gravatar.com/avatar/35948c039f71fe48d765768c07bfee67?s=90"/>
                
            </a>
            <span class="sidebar-profile-name">Orest Prystayko</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archive</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/qetr1ck-op" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.linkedin.com/profile/preview?locale=ru_RU&trk=prof-0-sb-preview-primary-button" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">Linked In</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/oprystayko" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.facebook.com/orest.prustayko" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                    <span class="sidebar-button-desc">Facebook</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            JavaScript Promises
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Sun Jul 13 2014 13:43:08 GMT+0300">
	
		    Jul 13, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Javascript/">Javascript</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h1 id="table-of-contents">Table of Contents</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Promises_arrive_in_JavaScript_21"><span class="toc-text">Promises arrive in JavaScript!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Promisifying_XMLHttpRequest"><span class="toc-text">Promisifying XMLHttpRequest</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chaining"><span class="toc-text">Chaining</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Error_handling"><span class="toc-text">Error handling</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Creating_a_sequence"><span class="toc-text">Creating a sequence</span></a></li></ol>
<h1 id="Promises_arrive_in_JavaScript_21"><a href="#Promises_arrive_in_JavaScript_21" class="headerlink" title="Promises arrive in JavaScript!"></a>Promises arrive in JavaScript!</h1><p>Here’s how you create a promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do a thing, possibly async, then…</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* everything turned out fine */</span>) &#123;</span><br><span class="line">    resolve(<span class="string">"Stuff worked!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    reject(<span class="built_in">Error</span>(<span class="string">"It broke"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The <code>promise constructor</code> takes one argument, a callback with two parameters, <code>resolve</code> and <code>reject</code>. Do something within the callback, perhaps async, then call resolve if everything worked, otherwise call reject.</p>
<p>Here’s how you use that promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(res) <span class="comment">//Stuff worked!</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(err) <span class="comment">//Error!</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>then</code> takes two arguments, a callback for a <code>success</code> case, and another for the <code>failure</code> case. Both are optional, so you can add a callback for the success or failure case only.</p>
<h1 id="Promisifying_XMLHttpRequest"><a href="#Promisifying_XMLHttpRequest" class="headerlink" title="Promisifying XMLHttpRequest"></a>Promisifying XMLHttpRequest</h1><p>Old APIs will be updated to use promises, if it’s possible in a backwards compatible way. <code>XMLHttpRequest</code> is a prime candidate, but in the mean time let’s write a simple function to make a GET request:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Return a new promise.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do the usual XHR stuff</span></span><br><span class="line">    <span class="keyword">var</span> req = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    req.open(<span class="string">'GET'</span>, url);</span><br><span class="line"></span><br><span class="line">    req.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// This is called even on 404 etc</span></span><br><span class="line">      <span class="comment">// so check the status</span></span><br><span class="line">      <span class="keyword">if</span> (req.status == <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="comment">// Resolve the promise with the response text</span></span><br><span class="line">        resolve(req.response);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise reject with the status text</span></span><br><span class="line">        <span class="comment">// which will hopefully be a meaningful error</span></span><br><span class="line">        reject(<span class="built_in">Error</span>(req.statusText));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle network errors</span></span><br><span class="line">    req.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="built_in">Error</span>(<span class="string">"Network Error"</span>));</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make the request</span></span><br><span class="line">    req.send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now let’s use it:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get(<span class="string">'story.json'</span>).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(response)</span></span> &#123;</span><br><span class="line">  console.log(<span class="string">"Success!"</span>, response);</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span><span class="params">(error)</span></span> &#123;</span><br><span class="line">  console.<span class="built_in">error</span>(<span class="string">"Failed!"</span>, <span class="built_in">error</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h1 id="Chaining"><a href="#Chaining" class="headerlink" title="Chaining"></a>Chaining</h1><p><code>then</code> isn’t the end of the story, you can chain <code>then&quot;s</code> together to transform values or run additional async actions one after another:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  resolve(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val); <span class="comment">// 1</span></span><br><span class="line">  <span class="keyword">return</span> val + <span class="number">2</span>;</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val); <span class="comment">// 3</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>As a practical example, let’s go back to:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get(<span class="string">'story.json'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(response);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Yey JSON!"</span>, response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>getJSON</code> still returns a promise, one that fetches a url then parses the response as JSON.</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getJSON</span><span class="params">(url)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">get</span>(url).then(JSON.parse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Error_handling"><a href="#Error_handling" class="headerlink" title="Error handling"></a>Error handling</h1><p>As we saw earlier, <code>then</code> takes two arguments, one for <code>success</code>, one for <code>failure</code> (or fulfill and reject, in promises-speak):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get(<span class="string">'story.json'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Success!"</span>, response);</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Failed!"</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>You can also use <code>catch</code>:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>(<span class="string">'story.json'</span>).then(<span class="function"><span class="keyword">function</span><span class="params">(response)</span> </span>&#123;</span><br><span class="line">  console.log(<span class="string">"Success!"</span>, response);</span><br><span class="line">&#125;).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span><span class="params">(error)</span> </span>&#123;</span><br><span class="line">  console.log(<span class="string">"Failed!"</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>With our story and chapters, we can use catch to display an error to the user:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">getJSON(<span class="string">'story.json'</span>).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(story)</span> &#123;</span></span><br><span class="line">  <span class="keyword">return</span> getJSON(<span class="transposed_variable">story.</span>chapterUrls<span class="matrix">[<span class="number">0</span>]</span>);</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(chapter1)</span> &#123;</span></span><br><span class="line">  addHtmlToPage(<span class="transposed_variable">chapter1.</span>html);</span><br><span class="line">&#125;).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  addTextToPage(<span class="string">"Failed to show chapter"</span>);</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  <span class="transposed_variable">document.</span>querySelector(<span class="string">'.spinner'</span>).<span class="transposed_variable">style.</span>display = <span class="string">'none'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Creating_a_sequence"><a href="#Creating_a_sequence" class="headerlink" title="Creating a sequence"></a>Creating a sequence</h1><p>But how can we loop through the <code>story.chapter</code> urls and fetch them in order?</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getJSON(<span class="string">'story.json'</span>).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(story)</span> &#123;</span></span><br><span class="line">  addHtmlToPage(<span class="transposed_variable">story.</span>heading);</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> for each url in story.chapterUrls, fetch &amp; display</span></span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  <span class="comment">// And we're all done!</span></span><br><span class="line">  addTextToPage(<span class="string">"All done"</span>);</span><br><span class="line">&#125;).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span><span class="params">(err)</span> &#123;</span></span><br><span class="line">  <span class="comment">// Catch any error that happened along the way</span></span><br><span class="line">  addTextToPage(<span class="string">"Argh, broken: "</span> + <span class="transposed_variable">err.</span>message);</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  <span class="comment">// Always hide the spinner</span></span><br><span class="line">  <span class="transposed_variable">document.</span>querySelector(<span class="string">'.spinner'</span>).<span class="transposed_variable">style.</span>display = <span class="string">'none'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This doesn’t work:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">story.chapterUrls.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span><span class="params">(chapterUrl)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Fetch chapter</span></span><br><span class="line">  getJSON(chapterUrl).then(<span class="function"><span class="keyword">function</span><span class="params">(chapter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// and add it to the page</span></span><br><span class="line">    addHtmlToPage(chapter.html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We want to turn our chapterUrls array into a <code>sequence of promises</code>. We can do that using <code>then</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start off with a promise that always resolves</span></span><br><span class="line"><span class="keyword">var</span> sequence = <span class="built_in">Promise</span>.resolve();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop through our chapter urls</span></span><br><span class="line">story.chapterUrls.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chapterUrl</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Add these actions to the end of the sequence</span></span><br><span class="line">  sequence = sequence.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getJSON(chapterUrl);</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">chapter</span>) </span>&#123;</span><br><span class="line">    addHtmlToPage(chapter.html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We can tidy up the above code using <code>array.reduce</code>:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Loop through our chapter urls</span></span><br><span class="line"><span class="transposed_variable">story.</span><span class="transposed_variable">chapterUrls.</span>reduce(<span class="function"><span class="keyword">function</span><span class="params">(sequence, chapterUrl)</span> &#123;</span></span><br><span class="line">  <span class="comment">// Add these actions to the end of the sequence</span></span><br><span class="line">  <span class="keyword">return</span> <span class="transposed_variable">sequence.</span><span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">    <span class="keyword">return</span> getJSON(chapterUrl);</span><br><span class="line">  &#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(chapter)</span> &#123;</span></span><br><span class="line">    addHtmlToPage(<span class="transposed_variable">chapter.</span>html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, <span class="transposed_variable">Promise.</span>resolve());</span><br></pre></td></tr></table></figure>
<p>Let’s put it all together…</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">getJSON(<span class="string">'story.json'</span>).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(story)</span> &#123;</span></span><br><span class="line">  addHtmlToPage(<span class="transposed_variable">story.</span>heading);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="transposed_variable">story.</span><span class="transposed_variable">chapterUrls.</span>reduce(<span class="function"><span class="keyword">function</span><span class="params">(sequence, chapterUrl)</span> &#123;</span></span><br><span class="line">    <span class="comment">// Once the last chapter's promise is done…</span></span><br><span class="line">    <span class="keyword">return</span> <span class="transposed_variable">sequence.</span><span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">      <span class="comment">// …fetch the next chapter</span></span><br><span class="line">      <span class="keyword">return</span> getJSON(chapterUrl);</span><br><span class="line">    &#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(chapter)</span> &#123;</span></span><br><span class="line">      <span class="comment">// and add it to the page</span></span><br><span class="line">      addHtmlToPage(<span class="transposed_variable">chapter.</span>html);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="transposed_variable">Promise.</span>resolve());</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  <span class="comment">// And we're all done!</span></span><br><span class="line">  addTextToPage(<span class="string">"All done"</span>);</span><br><span class="line">&#125;).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span><span class="params">(err)</span> &#123;</span></span><br><span class="line">  <span class="comment">// Catch any error that happened along the way</span></span><br><span class="line">  addTextToPage(<span class="string">"Argh, broken: "</span> + <span class="transposed_variable">err.</span>message);</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  <span class="comment">// Always hide the spinner</span></span><br><span class="line">  <span class="transposed_variable">document.</span>querySelector(<span class="string">'.spinner'</span>).<span class="transposed_variable">style.</span>display = <span class="string">'none'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>But we can do better. At the moment our page is downloading like this:</p>
<p><img src="http://www.html5rocks.com/en/tutorials/es6/promises/promise1.gif" alt=""></p>
<p>Browsers aren’t pretty good at downloading <code>multiple</code> things at once, so we’re losing performance by downloading chapters one after the other. What we want to do is download them all at the same time, then process them when they’ve all arrived. Thankfully there’s an API for this:</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Promise.<span class="built_in">all</span>(arrayOfPromises).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(arrayOfResults)</span></span> &#123;</span><br><span class="line">  //...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>Promise.all</code> takes an array of promises and creates a promise that fulfills when all of them successfully complete. You get an array of results (whatever the promises fulfilled to) in the same order as the promises you passed in.</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">getJSON(<span class="string">'story.json'</span>).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(story)</span> &#123;</span></span><br><span class="line">  addHtmlToPage(<span class="transposed_variable">story.</span>heading);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Take an array of promises and wait on them all</span></span><br><span class="line">  <span class="keyword">return</span> <span class="transposed_variable">Promise.</span>all(</span><br><span class="line">    <span class="comment">// Map our array of chapter urls to</span></span><br><span class="line">    <span class="comment">// an array of chapter json promises</span></span><br><span class="line">    <span class="transposed_variable">story.</span><span class="transposed_variable">chapterUrls.</span>map(getJSON)</span><br><span class="line">  );</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(chapters)</span> &#123;</span></span><br><span class="line">  <span class="comment">// Now we have the chapters jsons in order! Loop through…</span></span><br><span class="line">  <span class="transposed_variable">chapters.</span>forEach(<span class="function"><span class="keyword">function</span><span class="params">(chapter)</span> &#123;</span></span><br><span class="line">    <span class="comment">// …and add to the page</span></span><br><span class="line">    addHtmlToPage(<span class="transposed_variable">chapter.</span>html);</span><br><span class="line">  &#125;);</span><br><span class="line">  addTextToPage(<span class="string">"All done"</span>);</span><br><span class="line">&#125;).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span><span class="params">(err)</span> &#123;</span></span><br><span class="line">  <span class="comment">// catch any error that happened so far</span></span><br><span class="line">  addTextToPage(<span class="string">"Argh, broken: "</span> + <span class="transposed_variable">err.</span>message);</span><br><span class="line">&#125;).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">  <span class="transposed_variable">document.</span>querySelector(<span class="string">'.spinner'</span>).<span class="transposed_variable">style.</span>display = <span class="string">'none'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Depending on connection, this can be seconds faster than loading one-by-one:</p>
<p><img src="http://www.html5rocks.com/en/tutorials/es6/promises/promise2.gif" alt=""></p>

            
                

            
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Promises/">Promises</a> <a class="tag tag--primary tag--small t-link" href="/tags/XHR/">XHR</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/07/14/Deferred-and-promise-in-jQuery/"  data-tooltip="Deferred and promise in jQuery">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/07/02/Class-manipulation-in-Javascript-jQuery-and-AngularJS/" data-tooltip="Class manipulation in Javascript, jQuery and AngularJS">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Orest Prystayko. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/07/14/Deferred-and-promise-in-jQuery/"  data-tooltip="Deferred and promise in jQuery">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/07/02/Class-manipulation-in-Javascript-jQuery-and-AngularJS/" data-tooltip="Class manipulation in Javascript, jQuery and AngularJS">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://qetr1ck-op.github.io/2014/07/13/JavaScript-Promises/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="http://www.gravatar.com/avatar/35948c039f71fe48d765768c07bfee67?s=110"/>
        
            <h4 id="about-card-name">Orest Prystayko</h4>
        
            <h5 id="about-card-bio"><p>I try to learn something new every day. It may relate to personal finances, physical health, algorithms, computer programming. And the learning process might take place for a few minutes or from sunrise to sunset. I bealive that every time when I achieve new knowledge, I tipically observe how increase my quality of live.</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Front-End Developer @ Eleks</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Ukraine, Lviv
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'qetr1ck-op';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','yjp7PCgxKmcfHTQ63jfa','2.0.0');
    </script>


<!-- <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//qetr1ck-op.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> -->

</html>
